# 第六章：图像与视频压缩中的率失真

本章探讨率失真理论在实际图像和视频编码标准中的应用，包括JPEG、H.264、H.265和AV1。我们将看到理论如何指导实践：DCT变换、量化表设计、率失真优化（RDO）等核心技术都源自率失真理论。

**学习目标**：
- 理解DCT变换的率失真意义
- 掌握量化表设计的原理
- 了解视频编码中的RDO技术
- 建立从理论到实践的联系

---

## 6.1 JPEG图像压缩

### 6.1.1 JPEG编码流程

JPEG（Joint Photographic Experts Group）是最经典的有损图像压缩标准。其核心流程：

```
原始图像 → 分块 → DCT变换 → 量化 → 熵编码 → 压缩数据
          (8×8)   (频域)    (有损)  (无损)
```

每一步都与率失真理论密切相关。

### 6.1.2 DCT变换：能量压缩

**离散余弦变换**（DCT）将空间域的8×8图像块转换到频域：

$$F(u,v) = \sum_{x=0}^{7} \sum_{y=0}^{7} f(x,y) \cos\frac{(2x+1)u\pi}{16} \cos\frac{(2y+1)v\pi}{16}$$

**为什么用DCT？率失真视角**：

1. **能量压缩**：自然图像的能量集中在低频，DCT将能量聚集到少数系数

2. **去相关**：相邻像素高度相关，DCT使系数接近独立

3. **接近KLT**：对于一阶马尔可夫过程，DCT近似最优的KLT（Karhunen-Loève变换）

4. **率失真增益**：变换后的系数分布更接近独立高斯，可以利用第三章的率失真函数

**Rule of thumb**：DCT本身是无损的，但它为后续的有损量化创造了有利条件。低频系数重要（大方差），高频系数次要（小方差），符合水注入原理。

### 6.1.3 量化：率失真权衡的实现

量化是JPEG中唯一的有损步骤。对每个DCT系数 $F(u,v)$：

$$F_Q(u,v) = \text{round}\left(\frac{F(u,v)}{Q(u,v)}\right)$$

其中 $Q(u,v)$ 是**量化表**（quantization table），不同频率有不同的量化步长。

**标准JPEG量化表**（亮度）：

```
   低频    →    高频
 16  11  10  16  24  40  51  61
 12  12  14  19  26  58  60  55
 14  13  16  24  40  57  69  56
 14  17  22  29  51  87  80  62
 18  22  37  56  68 109 103  77
 24  35  55  64  81 104 113  92
 49  64  78  87 103 121 120 101
 72  92  95  98 112 100 103  99
```

**观察**：
- 左上角（低频）：小步长 → 精细量化 → 低失真
- 右下角（高频）：大步长 → 粗糙量化 → 高失真
- 这正是**水注入**的实践：高方差分量（低频）分配多比特，低方差分量（高频）分配少比特

**质量因子**（Quality Factor, QF）：

JPEG允许通过质量因子 $Q \in [1, 100]$ 缩放量化表：

$$Q_{\text{actual}}(u,v) = Q_{\text{base}}(u,v) \cdot \frac{100 - QF}{50}$$

- $QF = 100$：最小量化（接近无损）
- $QF = 50$：标准质量
- $QF = 10$：高压缩（高失真）

### 6.1.4 熵编码：实现理论码率

量化后的系数稀疏（多数为0），使用**霍夫曼编码**或**算术编码**进行无损压缩：

- **DC系数**（左上角）：DPCM编码（利用块间相关性）
- **AC系数**：Zigzag扫描 + 游程编码 + 霍夫曼编码

这对应率失真理论中的$R = I(X;\hat{X})$：量化后的符号分布通过熵编码达到接近熵的码率。

**Rule of thumb**：JPEG的实际码率约为理论码率的 1.2-1.5 倍（由于块间独立性假设、量化表固定等因素）。

---

## 6.2 H.264/H.265视频压缩

### 6.2.1 视频编码的额外维度

视频相比图像增加了时间维度，带来更多冗余和压缩机会：

- **时间冗余**：相邻帧高度相似
- **空间冗余**：帧内像素相关性（类似JPEG）

**H.264/AVC**和**H.265/HEVC**是现代视频编码标准。

### 6.2.2 帧间预测与运动补偿

**核心思想**：不直接编码当前帧，而是编码与参考帧的**差异**（残差）

```
当前帧 → 运动估计 → 运动向量 ┐
                              ├→ 残差 → DCT → 量化 → 熵编码
参考帧 → 运动补偿 → 预测块 ┘
```

**率失真视角**：
- 预测块接近当前块 → 残差小 → 失真小，但运动向量需要码率
- 预测块粗糙 → 残差大 → 失真大，但运动向量简单（码率小）
- 权衡：$R_{\text{total}} = R_{\text{residual}} + R_{\text{MV}}$，$D = $ 重建失真

### 6.2.3 率失真优化（RDO）

**问题**：编码器有多种选择（帧内/帧间预测、块大小、运动向量、量化参数等），如何选择最优？

**拉格朗日RDO**：对于每个编码决策，最小化

$$J = D + \lambda R$$

其中：
- $D$：失真（通常是MSE或SAD）
- $R$：码率（实际比特数或估计）
- $\lambda$：拉格朗日乘子（由QP确定）

**典型RDO决策**：

1. **模式选择**：选择帧内16×16、8×8、4×4，或帧间预测
   $$\text{Mode} = \arg\min_m (D_m + \lambda R_m)$$

2. **运动估计**：选择最优运动向量
   $$\text{MV} = \arg\min_{\text{mv}} (D_{\text{pred}}(\text{mv}) + \lambda R_{\text{MV}}(\text{mv}))$$

3. **块分割**：选择最优块大小（H.264: 16×16到4×4，H.265: 64×64到4×4）

**$\lambda$ 的选择**：经验公式

$$\lambda = 0.85 \cdot 2^{(QP-12)/3}$$

其中QP是量化参数。这个公式源自理论推导和大量实验调优。

**Rule of thumb**：RDO是现代视频编码器性能的关键。软件编码器（如x264、x265）花费大量计算在RDO上，可以比硬件编码器获得20-30%的码率节省（相同质量）。

### 6.2.4 H.265的率失真改进

H.265（HEVC）相比H.264（AVC），在相同质量下码率减半。主要改进：

1. **更大的块**：CTU（Coding Tree Unit）64×64（vs H.264的16×16）
   - 符合率失真理论：高分辨率视频的平坦区域更大，大块更高效

2. **更灵活的变换**：4×4到32×32的DCT/DST
   - 大块用大变换，小块用小变换，适应局部特性

3. **更精细的预测**：35种帧内预测方向（vs H.264的9种）
   - 更好的预测 → 更小的残差 → 更低的码率

4. **Sample Adaptive Offset（SAO）**：后处理滤波器
   - 减少量化误差在平坦区域的视觉伪影

5. **改进的RDO**：更全面的搜索空间、更准确的码率估计

---

## 6.3 AV1和现代编码器

### 6.3.1 AV1（AOMedia Video 1）

AV1是开放、免费的下一代视频编码标准（2018），由谷歌、Mozilla、Netflix等开发。

**性能**：相比H.265，相同质量下码率再减少约30%

**核心技术**（率失真视角）：

1. **超级块**（Superblock）：128×128
   - 更大的上下文用于预测和变换

2. **更多变换**：DCT、ADST（非对称DST）、WHT、identity
   - 针对不同残差特性选择最优变换

3. **帧内预测**：方向预测 + 滤波预测 + Paeth预测
   - 更精确的预测 → 更小的残差

4. **CDEF（Constrained Directional Enhancement Filter）**：
   - 方向性去块效应滤波，减少量化伪影

5. **Wiener滤波器**：在重建帧上应用自适应滤波
   - 在率失真意义下优化滤波器系数

6. **端到端RDO**：几乎所有决策都通过RDO优化

**挑战**：编码复杂度极高（是H.265的10-100倍），主要用于离线编码（如Netflix、YouTube）。

### 6.3.2 码率控制

实际应用中（如流媒体），需要控制码率满足带宽约束。

**目标**：给定目标码率 $R_{\text{target}}$，分配码率到各帧使总失真最小

$$\min \sum_i D_i \quad \text{s.t.} \quad \sum_i R_i = R_{\text{target}}$$

**方法**：
1. **两次编码**（Two-pass）：第一次统计复杂度，第二次根据复杂度分配码率
2. **单次编码**（One-pass）：根据局部缓冲区状态动态调整QP

**率失真意义**：复杂帧（运动剧烈、细节丰富）分配更多码率，简单帧分配更少，符合水注入原理（复杂帧的"方差"大）。

**Rule of thumb**：Two-pass编码质量最好但延迟高，用于离线场景（视频网站）。One-pass用于实时场景（视频会议、直播），质量略差但延迟低。

---

## 6.4 率失真曲线的实际测量

### 6.4.1 绘制RD曲线

评估编码器性能的标准方法：

1. 对测试视频，用不同QP（如QP=22, 27, 32, 37）编码
2. 记录每个QP的码率 $R_i$ 和失真 $D_i$（PSNR或SSIM）
3. 绘制曲线 $(R_i, D_i)$

**示例**：

```
PSNR (dB)
  45 |           *  H.265
     |       *
  40 |   *           *  H.264
     | *         *
  35 |       *           *  JPEG
     |   *
  30 | *
     +---------------------→ Bitrate (kbps)
     0   500  1000  1500
```

### 6.4.2 BD-rate（Bjøntegaard Delta Rate）

比较两个编码器时，使用**BD-rate**度量：

$$\text{BD-rate} = \frac{\int \log R_1(D) dD - \int \log R_2(D) dD}{\int dD}$$

负值表示编码器1更好（相同质量下码率更低）。

**例**：H.265相比H.264，BD-rate约为-50%，意味着相同质量下码率减半。

---

## 6.5 本章小结

**核心概念**：

1. **JPEG**：
   - DCT变换：能量压缩，去相关
   - 量化表：水注入的实践（低频精细，高频粗糙）
   - 熵编码：达到接近熵的码率

2. **H.264/H.265**：
   - 帧间预测：利用时间冗余
   - RDO：$J = D + \lambda R$，优化所有编码决策
   - 块大小、变换类型：适应局部特性

3. **AV1**：
   - 更大块、更多工具
   - 端到端RDO
   - 复杂度与性能的权衡

4. **码率控制**：
   - 分配码率到不同帧
   - 符合水注入原理

**关键技术**：

- DCT变换：$F(u,v) = \sum_{x,y} f(x,y) \cos(...) \cos(...)$
- 量化：$F_Q = \text{round}(F / Q)$
- RDO：$J = D + \lambda R$
- BD-rate：编码器性能比较指标

---

## 6.6 常见陷阱与错误

### Gotcha #1: DCT是有损的？

**错误**：认为DCT变换本身引入失真。

**正解**：DCT是**正交变换，完全可逆**，没有信息损失。有损来自**量化**步骤。DCT的作用是将能量聚集，为量化创造条件。

### Gotcha #2: 量化表是固定的

**错误**：认为JPEG必须使用标准量化表。

**正解**：量化表可以自定义。实际中，编码器可以优化量化表适应特定图像（如libjpeg-turbo的-optimize选项）。标准表只是经验设计的起点。

### Gotcha #3: QP和QF的关系

**错误**：混淆H.264的QP（Quantization Parameter）和JPEG的QF（Quality Factor）。

**正解**：它们都控制质量，但定义不同：
- JPEG QF：100=高质量，0=低质量（直观）
- H.264 QP：0=无损，51=最差质量（反直觉）
- QP每增加6，码率约减半

### Gotcha #4: PSNR无穷大

**错误**：当重建与原始完全相同时，PSNR = ∞，在绘制RD曲线时出错。

**正解**：处理方法：
- 设定PSNR上限（如100 dB）
- 对于无损点，单独标注
- 绘制PSNR vs QP，而非vs bitrate

### Gotcha #5: $\lambda$ 的单位

**错误**：忽略$\lambda$的单位不匹配。

**正解**：$D$ 通常是像素域的MSE（如SAD），$R$ 是比特数。$\lambda$ 的单位是"像素差异/比特"，其值取决于 $D$ 的度量。如果用PSNR作为 $D$（dB），$\lambda$ 的含义完全不同。

实际中，$\lambda$ 通过经验公式（如 $\lambda = 0.85 \cdot 2^{(QP-12)/3}$）确定，已经考虑了单位。

### Gotcha #6: RDO的计算复杂度

**错误**：认为RDO可以对所有可能性穷举。

**正解**：完全穷举不可行（组合爆炸）。实际编码器使用启发式搜索：
- 运动估计：菱形搜索、EPZS等快速算法
- 模式选择：根据粗略估计剪枝
- 编码复杂度vs性能：x264有ultrafast到placebo共10档，差异可达100倍

### Gotcha #7: 理论RD界 vs 实际

**错误**：期望实际编码器达到理论率失真界。

**正解**：实际编码器远未达到理论界（$R(D) = \frac{1}{2}\log\frac{\sigma^2}{D}$ for高斯源）。原因：
- 块独立假设（忽略块间相关性）
- 有限的预测、变换选项
- 整数运算、定点量化
- 复杂度限制

实际编码器距理论界约3-6 dB（对于高斯源）。这是未来改进空间。

---

**下一章预告**：第七章将探讨字典学习和稀疏编码的率失真解释，理解稀疏性如何对应"率"，重建误差如何对应"失真"。

[← 第五章](chapter5.md) | [返回目录](index.md) | [第七章：字典学习与稀疏编码的率失真 →](chapter7.md)
